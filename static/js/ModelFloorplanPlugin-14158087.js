import{u as _,D as L}from"./useFetchDatas-b277a088.js";import{F as p,aA as k,r as y,a as G,u as T,b as W,a9 as j,j as d,aa as z,d as N,ab as R,ac as F,ad as q,ae as U,c as H,p as B,e as V,B as $,$ as J}from"./vendor-b2bf1e8d.js";import{a as c,b as S,S as K,F as Y}from"./typings-ddaad332.js";import{g as Q,c as I,o as X,C as Z}from"./changeModelCanvasOpacity-ba3e773b.js";import{f as ee}from"./RoomHighlight-ba554c03.js";import{g as te}from"./getInitialParamFromUrl-141e6748.js";async function g(r){try{const e=await r;return[null,e]}catch(e){return e instanceof Error?[e,null]:[new Error(""),null]}}function m(r){return Object.prototype.toString.call(r)==="[object Object]"}function v(r,e){return r===e?!0:typeof r!=typeof e?!1:!!(Number.isNaN(r)&&Number.isNaN(e))}function re(r,e){const i=Object.getOwnPropertyNames(r),s=Object.getOwnPropertyNames(e);if(i.length!==s.length)return!1;for(let t=0,n=i.length;t<n;t++){const o=i[t];if(!v(r[o],e[o]))return!1}return!0}function ie(r,e){if(r.length!==e.length)return!1;for(let i=0,s=r.length;i<s;i++)if(!v(r[i],e[i]))return!1;return!0}function ne(r,e){return v(r,e)?!0:m(r)&&m(e)?re(r,e):Array.isArray(r)&&Array.isArray(e)?ie(r,e):!1}function M(r,e){return v(r,e)?!0:m(r)&&m(e)?ae(r,e):Array.isArray(r)&&Array.isArray(e)?oe(r,e):!1}function oe(r,e){if(r.length!==e.length)return!1;for(let i=0,s=r.length;i<s;i++)if(!M(r[i],e[i]))return!1;return!0}function ae(r,e){const i=Object.getOwnPropertyNames(r),s=Object.getOwnPropertyNames(e);if(i.length!==s.length)return!1;for(let t=0,n=i.length;t<n;t++){const o=i[t];if(!M(r[o],e[o]))return!1}return!0}function se(r,e,i={deep:!1}){return i.deep?M(r,e):ne(r,e)}async function le(r,...e){const[i]=await g(r.changeMode(...e));if(i)throw i;await new Promise((s,t)=>{r.once("initAnimationEnded",s);const n=o=>{o!==e[0]&&t("changeMode \u88AB\u4E2D\u65AD"),r.off("modeChange",n)};r.on("modeChange",n)})}function A(r,e,i=4){return Math.floor(r*Math.pow(10,i))===Math.floor(e*Math.pow(10,i))}function O(r,e){if(r.currentMode!==p.Mode.Floorplan)return!1;const{latitude:i,longitude:s,fov:t}=e,{latitude:n,longitude:o}=r.getCurrentState(),l=r.camera.fov;return!!(A(i,n,1)&&A(s,o,1)&&t===l)}async function ue(r,e,i=!0){if(O(r,e)===!0)return;if(r.currentMode!==p.Mode.Floorplan){const[a]=await g(le(r,p.Mode.Floorplan,e,void 0,i));if(a)throw a;if(O(r,e)===!1)throw new Error(c.ChangeModeError);return}const{latitude:t,longitude:n,fov:o}=r.getCurrentState(),l=Math.min(1e3,Math.max(200,Math.abs(t-Math.PI/2)*1e3,(n>Math.PI?2*Math.PI-n:n)*500,Math.abs(o-e.fov)*10)),[u]=await g(r.updateCamera(e,l,i));if(u)throw new Error(c.UpdateCameraError)}const he="modelFloorplanPlugin";class de{constructor(e,i){var s;Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:he}),Object.defineProperty(this,"hooks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"visible",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:{width:0,height:0}}),Object.defineProperty(this,"app",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pxmm",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"five",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"panoIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"floorIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"configs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"lastPanoramaLongitude",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"selector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"floorplanData",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wrapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"container",{enumerable:!0,configurable:!0,writable:!0,value:document.createElement("div")}),Object.defineProperty(this,"showState",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ModelFloorplanPluginsShowOpts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"showPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"showRejection",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dispose",{enumerable:!0,configurable:!0,writable:!0,value:()=>{var t,n;const o=this.five;this.hide(),(t=this.app)===null||t===void 0||t.$destroy(),(n=this.container)===null||n===void 0||n.remove(),o.off("modelLoaded",this.handleModelLoaded),o.off("modeChange",this.handleModeChange),o.off("panGesture",this.handlePanGesture),o.off("panoArrived",this.handlePanoArrived),o.off("wantsChangeMode",this.handleWantsChangeMode),o.off("wantsInteriaPan",this.handleWantsInteriaPan),o.off("wantsTapGesture",this.handleWantsTapGesture),o.off("modelShownFloorChange",this.onModelShownFloorChange)}}),Object.defineProperty(this,"updateSize",{enumerable:!0,configurable:!0,writable:!0,value:()=>{if(!this.floorplanData||!O(this.five,this.showState)||!this.container||!this.wrapper)return;const{min:t,max:n}=this.floorplanData.bounding,o=n.x-t.x,l=n.y-t.y,u=this.configs.attachedTo?{attachedTo:this.configs.attachedTo}:void 0,a=Q(this.five,this.wrapper,this.floorIndex,u),h=Math.ceil(o*a),f=Math.ceil(l*a);this.size.width===h&&this.size.height===f||(this.pxmm=a,this.size={width:h,height:f},this.container.style.width=h+"px",this.container.style.height=f+"px")}}),Object.defineProperty(this,"show",{enumerable:!0,configurable:!0,writable:!0,value:async t=>{var n,o;if(!this.showPromise&&this.visible)return!0;if(!((n=this.five.model)===null||n===void 0?void 0:n.loaded))throw new Error(c.ModelNotLoaded);if(!this.floorplanData)throw new Error(c.DataNotLoaded);if(this.visible=!0,this.showPromise){const a=se(t,this.ModelFloorplanPluginsShowOpts,{deep:!1});if(!!this.showPromise&&a)return this.showPromise;!!this.showPromise&&!a&&((o=this.showRejection)===null||o===void 0||o.call(this,c.DifferentShowParams))}this.ModelFloorplanPluginsShowOpts=t;const u=(async()=>{var a,h;let f=!1,b;this.showRejection=D=>{f=!0,b=D};const[w]=await g(ue(this.five,this.showState,t==null?void 0:t.userAction));if(w)throw w;if(f)throw b?new Error(b):new Error(c.UnknownError);if(!this.visible)throw new Error(c.UnknownError);this.visible=!0,this.updateSize(),(t==null?void 0:t.floorIndex)&&(this.floorIndex=t.floorIndex),this.five.model.show(this.floorIndex);const P=(h=(a=t==null?void 0:t.modelOpacity)!==null&&a!==void 0?a:this.configs.modelOpacity)!==null&&h!==void 0?h:1,E=(t==null?void 0:t.immediately)?0:K;return I(this.five,P,E),this.render(E),this.five.on("wantsGesture",this.handleWantsGesture),this.five.on("wantsTapGesture",this.handleWantsTapGesture),!0})().then(()=>{var a;return this.hooks.emit("showAnimationEnded",{auto:!!(t==null?void 0:t.isAutoShow),userAction:(a=t==null?void 0:t.userAction)!==null&&a!==void 0?a:!0}),!0}).catch(a=>{if((t==null?void 0:t.isAutoShow)||!(a instanceof Error))return!1;throw a}).finally(()=>{this.showPromise=void 0,this.showRejection=void 0});return this.showPromise=u,u}}),Object.defineProperty(this,"hide",{enumerable:!0,configurable:!0,writable:!0,value:t=>{var n,o;if(this.size.width===0||this.visible===!1)return!0;const l=!!(t==null?void 0:t.isAutoHide);return this.five.off("wantsGesture",this.handleWantsGesture),this.five.off("wantsTapGesture",this.handleWantsTapGesture),this.visible=!1,(n=this.showRejection)===null||n===void 0||n.call(this,c.BreakOffByHide),I(this.five,1,0),this.render(),this.hooks.emit("hide",{auto:l,userAction:(o=t==null?void 0:t.userAction)!==null&&o!==void 0?o:!0}),!0}}),Object.defineProperty(this,"onModelShownFloorChange",{enumerable:!0,configurable:!0,writable:!0,value:t=>{if(this.floorIndex!==t){if(t===null){const n=this.five.getCurrentState().panoIndex;this.floorIndex=this.five.work.observers[n].floorIndex;return}this.floorIndex=t,this.updateSize(),this.render()}}}),Object.defineProperty(this,"handleModelLoaded",{enumerable:!0,configurable:!0,writable:!0,value:()=>{if(this.wrapper||!this.selector)return;const t=this.selector instanceof Element?this.selector:document.querySelector(this.selector);if(!t)throw new Error("\u4E0D\u6B63\u786E\u7684\u7236\u5BB9\u5668\u9009\u62E9\u5668");this.wrapper=t,t.append(this.container)}}),Object.defineProperty(this,"handleClick",{enumerable:!0,configurable:!0,writable:!0,value:()=>{if(!this.visible)return;if(this.hooks.emit("click"))return!1}}),Object.defineProperty(this,"handleWantsTapGesture",{enumerable:!0,configurable:!0,writable:!0,value:()=>this.handleClick()}),Object.defineProperty(this,"handleWantsChangeMode",{enumerable:!0,configurable:!0,writable:!0,value:t=>{t!=="Panorama"&&(this.lastPanoramaLongitude=this.five.getCurrentState().longitude),t!=="Floorplan"&&this.hide()}}),Object.defineProperty(this,"handleModeChange",{enumerable:!0,configurable:!0,writable:!0,value:t=>{t==="Floorplan"?this.five.on("panGesture",this.handlePanGesture):(this.hide(),this.five.off("panGesture",this.handlePanGesture))}}),Object.defineProperty(this,"handlePanoArrived",{enumerable:!0,configurable:!0,writable:!0,value:t=>{var n;!((n=this.five)===null||n===void 0?void 0:n.work)||(this.panoIndex=t,this.floorIndex=this.five.work.observers[t].floorIndex)}}),Object.defineProperty(this,"handleWantsInteriaPan",{enumerable:!0,configurable:!0,writable:!0,value:()=>{if(this.visible)return!1}}),Object.defineProperty(this,"handleWantsGesture",{enumerable:!0,configurable:!0,writable:!0,value:(t,n)=>{if(!!this.visible&&(n.length>1||t==="mouseWheel"))return!1}}),Object.defineProperty(this,"handlePanGesture",{enumerable:!0,configurable:!0,writable:!0,value:async({latitude:t,longitude:n},o)=>{if(this.five.getCurrentState().mode!=="Floorplan"||this.configs.autoShowEnable===!1)return;if(o&&this.visible)return this.five.setState(this.showState,!0);const l=Math.abs(t-Math.PI/2)>5*Math.PI/180,u=n>5*(Math.PI/180)&&n<355*(Math.PI/180),a=l||u;if(this.visible&&a)return this.hide({isAutoHide:!0});if(this.five.camera.fov/S<.8)return;const h=Math.abs(t-Math.PI/2)<10*Math.PI/180,f=n<30*(Math.PI/180)||n>330*(Math.PI/180);if(o&&!this.visible&&h&&f){const b=async(w,P)=>{!P||(this.five.off("interiaPan",b),await this.show({isAutoShow:!0}))};this.five.on("interiaPan",b);return}}}),this.five=e,this.hooks=new k,this.selector=i.selector,this.configs=X(i,["selector"]),this.showState={longitude:0,latitude:Math.PI/2,fov:S/((s=i==null?void 0:i.scale)!==null&&s!==void 0?s:1)},this.container.classList.add("floorplan-plugin"),Object.assign(this.container.style,{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)",zIndex:10}),this.five.addExtraElement(this.container),this.five.model.loaded?this.handleModelLoaded():e.once("modelLoaded",this.handleModelLoaded),e.once("dispose",this.dispose),e.on("modeChange",this.handleModeChange),e.on("panoArrived",this.handlePanoArrived),e.on("wantsChangeMode",this.handleWantsChangeMode),e.on("wantsInteriaPan",this.handleWantsInteriaPan),e.on("modelShownFloorChange",this.onModelShownFloorChange)}async load(e){const i=JSON.parse(JSON.stringify(e));this.floorplanData=await ee(i),this.render()}appendTo(e){return this.wrapper=e,e.appendChild(this.container),this}changeFloor(e){this.five.model.show(e)}changeConfigs(e){Object.assign(this.configs,e),!!this.container&&this.render()}render(e){if(!this.container||!this.floorplanData||this.size.width===0)return;const{northDesc:i,hoverEnable:s,cameraImageUrl:t,getLabelElement:n,roomLabelsEnable:o,compassEnable:l,ruleLabelsEnable:u}=this.configs,a={cameraImageUrl:t,getLabelElement:n,northDesc:i??"\u5317",visible:this.visible,duration:e??0,panoIndex:this.panoIndex,floorIndex:this.floorIndex,floorplanData:this.floorplanData,hoverEnable:s??!1,compassEnable:l??!0,ruleLabelsEnable:u??!0,roomLabelsEnable:o??!0,lastPanoramaLongitude:this.lastPanoramaLongitude};this.app?this.app.$set(a):this.app=new Z({target:this.container,intro:!0,props:a})}}const fe=(r,e)=>new de(r,e);function x(){return{width:window.innerWidth,height:window.innerHeight}}function ce(){const[r,e]=y.exports.useState(x);return y.exports.useEffect(()=>{const i=()=>e(x());return window.addEventListener("resize",i,!1),()=>window.removeEventListener("resize",i,!1)}),r}const be=r=>{const e=G(),[i,s]=T(),t=W(),n=_(L.FLOOR_PLAN_SERVER_PLUGIN_DATA);return y.exports.useEffect(()=>{e.plugins.modelFloorplanPlugin.hooks.on("showAnimationEnded",()=>{console.log("\u{1F436}-- ModelFloorplanPlugin -- show")}),e.plugins.modelFloorplanPlugin.hooks.on("hide",()=>{console.log("\u{1F436}-- ModelFloorplanPlugin -- hide")})},[e]),j("modelLoaded",()=>{!n||JSON.stringify(n)==="{}"||Promise.resolve(e.plugins.modelFloorplanPlugin.load(n)).then(()=>{e.plugins.modelFloorplanPlugin.show()})},[n]),j("initAnimationEnded",()=>{i.mode===p.Mode.Floorplan&&e.plugins.modelFloorplanPlugin.show()},[i.mode]),t!=="Loaded"?null:d(z,{sx:{position:"fixed",bottom:0,left:0,right:0,backgroundColor:"transparent"},className:"topview-floorplan-plugin-use",children:N(R,{showLabels:!0,value:i.mode,onChange:(o,l)=>{s({mode:l})},children:[d(F,{label:"\u5168\u666F\u6F2B\u6E38",icon:d(q,{}),value:p.Mode.Panorama}),d(F,{label:"\u7A7A\u95F4\u603B\u89C8",icon:d(U,{}),value:p.Mode.Floorplan})]})})},pe={attachedTo:Y.CEILING},C=te(),ge=JSON.stringify(C)!=="{}"?C:pe,me=H({imageOptions:{size:512},textureOptions:{size:512},plugins:[[fe,"modelFloorplanPlugin",{selector:".plugin-full-screen-container",...ge}]]}),ve=()=>{const r=ce(),e=_(L.WORK);return e&&N(me,{initialWork:B(e),ref:i=>Object.assign(window,{$five:i?.five}),children:[d(V,{...r}),d($,{className:"plugin-full-screen-container",sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none"}}),d(be,{})]})};J.render(d(ve,{}),document.querySelector("#app"));
