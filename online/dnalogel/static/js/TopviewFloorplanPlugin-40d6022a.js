import{u as g,D as w}from"./useFetchDatas-9069443e.js";import{r as d,a as b,u as E,b as F,j as i,ab as S,d as P,ac as C,ad as p,ae as M,F as c,af as y,c as L,p as T,e as D,B as I,R as A}from"./vendor-1f431ae3.js";import"./constants-62640824.js";import{f as O}from"./RoomHighlight-2a8d56e9.js";import{o as _,c as u,g as z,C as W}from"./changeModelCanvasOpacity-f62c5bf3.js";import{g as R}from"./getInitialParamFromUrl-9191fb83.js";const k={position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:"10"};class N{size={width:0,height:0};visible=!1;pxmm=0;app;five;panoIndex=0;floorIndex=0;configs={};lastPanoramaLongitude=0;selector;floorplanData;wrapper;container=document.createElement("div");constructor(e,t){this.five=e,this.selector=t.selector,this.configs=_(t,["selector"]),this.container.classList.add("floorplan-plugin"),Object.assign(this.container.style,k),this.five.model.loaded?this.handleModelLoaded():e.once("modelLoaded",this.handleModelLoaded),this.five.once("dispose",this.dispose),this.five.on("modeChange",this.handleModeChange),this.five.on("panoArrived",this.handlePanoArrived),this.five.on("initAnimationEnded",this.handleInitAnimationEnded),this.five.on("modelShownFloorChange",this.onModelShownFloorChange)}async load(e){const t=JSON.parse(JSON.stringify(e));this.floorplanData=await O(t),this.render()}appendTo(e){return this.wrapper=e,e.appendChild(this.container),this}dispose=()=>{this.hide(),this.container?.remove(),this.app?.$destroy(),this.five.off("modeChange",this.handleModeChange),this.five.off("panoArrived",this.handlePanoArrived),this.five.off("modelLoaded",this.handleModelLoaded),this.five.off("wantsMoveToPano",this.handleWantsMoveToPano),this.five.off("wantsPanGesture",this.handleWantsPanGesture),this.five.off("initAnimationEnded",this.handleInitAnimationEnded),this.five.off("modelShownFloorChange",this.onModelShownFloorChange)};onModelShownFloorChange=e=>{e!==null&&(this.floorIndex=e,this.updateSize(),this.render())};handlePanoArrived=e=>{!this.five?.work||(this.panoIndex=e,this.floorIndex=this.five.work.observers[e].floorIndex)};handleWantsMoveToPano=()=>{if(!!this.visible&&this.configs.preventRoomClick)return!1};handleWantsPanGesture=()=>{if(!!this.visible)return!1};handleModelLoaded=()=>{if(this.wrapper||!this.selector)return;const e=this.selector instanceof Element?this.selector:document.querySelector(this.selector);if(!e)throw new Error("\u4E0D\u6B63\u786E\u7684\u7236\u5BB9\u5668\u9009\u62E9\u5668");this.wrapper=e,e.append(this.container)};handleModeChange=e=>{if(e!=="Topview")return this.hide()};handleInitAnimationEnded=()=>{const{mode:e}=this.five.getCurrentState();e==="Topview"&&this.show()};show(){this.visible=!0,this.five.model.show(this.floorIndex),this.updateSize();const e=500,t=this.configs.modelOpacity;typeof t=="number"&&u(this.five,t,e),this.render(e),this.five.on("wantsMoveToPano",this.handleWantsMoveToPano),this.five.on("wantsPanGesture",this.handleWantsPanGesture)}hide(){this.visible=!1,u(this.five,1,0),this.render(),this.five.on("wantsMoveToPano",this.handleWantsMoveToPano),this.five.on("wantsPanGesture",this.handleWantsPanGesture)}updateSize=()=>{if(!this.floorplanData||!this.container||!this.wrapper||this.five.getCurrentState().mode!=="Topview")return;const{min:e,max:t}=this.floorplanData.bounding,r=t.x-e.x,l=t.y-e.y,n=this.configs.attachedTo?{attachedTo:this.configs.attachedTo}:void 0,s=z(this.five,this.wrapper,this.floorIndex,n),a=Math.ceil(r*s),h=Math.ceil(l*s);this.pxmm=s,this.size={width:a,height:h},this.container.style.width=a+"px",this.container.style.height=h+"px"};render(e){if(!this.container||!this.floorplanData||this.size.width===0)return;const{getLabelElement:t,cameraImageUrl:r,preventRoomClick:l,hoverEnable:n,compassEnable:s,roomLabelsEnable:a,ruleLabelsEnable:h}=this.configs,x=l?()=>!1:void 0,f={five:this.five,pxmm:this.pxmm,cameraImageUrl:r,visible:this.visible,duration:e??0,panoIndex:this.panoIndex,floorIndex:this.floorIndex,floorplanData:this.floorplanData,hoverEnable:n??!1,compassEnable:s??!0,ruleLabelsEnable:h??!0,roomLabelsEnable:a??!0,lastPanoramaLongitude:this.lastPanoramaLongitude,getLabelElement:t,onRoomHeightClick:x};this.app?this.app.$set(f):this.app=new W({target:this.container,intro:!0,props:f})}}const G=(o,e)=>new N(o,e);function v(){return{width:window.innerWidth,height:window.innerHeight}}function B(){const[o,e]=d.exports.useState(v);return d.exports.useEffect(()=>{const t=()=>e(v());return window.addEventListener("resize",t,!1),()=>window.removeEventListener("resize",t,!1)}),o}const j=o=>{const e=b(),[t,r]=E(),l=F(),n=g(w.FLOOR_PLAN_SERVER_PLUGIN_DATA);return d.exports.useEffect(()=>{if(!n||JSON.stringify(n)==="{}")return;e.plugins.topviewFloorplanPlugin.load(n)},[n]),l!=="Loaded"?null:i(S,{sx:{position:"fixed",bottom:0,left:0,right:0,backgroundColor:"transparent"},className:"topview-floorplan-plugin-use",children:P(C,{showLabels:!0,value:t.mode,onChange:(s,a)=>{r({mode:a})},children:[i(p,{label:"\u5168\u666F\u6F2B\u6E38",icon:i(M,{}),value:c.Mode.Panorama}),i(p,{label:"\u4FEF\u89C6\u6A21\u578B",icon:i(y,{}),value:c.Mode.Topview})]})})},U={hoverEnable:!0},m=R(),J=JSON.stringify(m)!=="{}"?m:U,$=L({imageOptions:{size:512},textureOptions:{size:512},plugins:[[G,"topviewFloorplanPlugin",{selector:".plugin-full-screen-container",...J}]]}),q=()=>{const o=B(),e=g(w.WORK);return e&&P($,{initialWork:T(e),ref:t=>Object.assign(window,{$five:t?.five}),children:[i(D,{...o}),i(I,{className:"plugin-full-screen-container",sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none"}}),i(j,{})]})};A.render(i(q,{}),document.querySelector("#app"));
