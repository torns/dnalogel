import{u as S,D as B}from"./useFetchDatas-b277a088.js";import{aR as I,aS as p,aq as C,ao as D,M as k,V as f,aT as G,aU as b,aV as P,a8 as F,T as W,r as z,b as N,u as U,a as $,a9 as H,d as M,B as E,j as m,aa as q,ab as K,ac as V,ad as X,F as _,ae as Y,c as J,p as Q,e as Z,f as ee}from"./vendor-b2bf1e8d.js";import{e as T}from"./typings-ddaad332.js";function te(s){if(s.length===0)return[];if(Array.isArray(s[0]))return s;let l=[];return s.map(e=>{const c=[e[T.TOP_LEFT],e[T.BOTTOM_LEFT],e[T.BOTTOM_RIGHT],e[T.TOP_RIGHT]];l.push(c)}),l}const re=(s,{videoElement:l})=>{const e={videoMeshes:[],videoTextureEnabled:!1,videoSource:"",rectPoints:[],enabled:!1,videoElement:l},c=t=>{e.videoTexture&&(e.videoTexture.image.muted=t,e.videoTexture.image.play())},h=()=>e.videoTexture?e.videoTexture.image.muted:!0,g=()=>{if(e.enabled||!e.videoTexture)return;e.enabled=!0,e.videoMeshes=w(),console.log("state.videoMeshes",e.videoMeshes),e.videoMeshes.forEach(o=>s.scene.add(o));const t=()=>{if(console.log("play",e.videoTexture),!e.videoTexture)return;const o=()=>{var i;!e.videoTexture||((i=e.videoTexture)===null||i===void 0||i.image.removeEventListener("timeupdate",o),e.videoTextureEnabled=!0,e.videoMeshes.forEach(n=>{n.material.map!==e.videoTexture&&(n.material.map=e.videoTexture)}),s.needsRender=!0)};e.videoTexture.image.addEventListener("timeupdate",o),e.videoTexture&&e.videoMeshes.length&&e.videoTexture.image.play()};if(s.model.loaded)t();else return s.once("modelLoaded",()=>t())},x=()=>{!e.enabled||(e.enabled=!1,e.videoMeshes.forEach(t=>{t.geometry.dispose(),t.material.dispose(),s.scene.remove(t),e.videoTexture&&e.videoTexture.image.pause()}),e.videoMeshes=[],s.needsRender=!0)},w=()=>e.rectPoints.map((t,o)=>{const i=new I,n=128,r=[];r.push(t[0].x,t[0].y,t[0].z);for(let a=1;a<n;a++)r.push(t[0].x+(t[1].x-t[0].x)*a/n,t[0].y+(t[1].y-t[0].y)*a/n,t[0].z+(t[1].z-t[0].z)*a/n);r.push(t[1].x,t[1].y,t[1].z),r.push(t[2].x,t[2].y,t[2].z);for(let a=1;a<n;a++)r.push(t[2].x+(t[3].x-t[2].x)*a/n,t[2].y+(t[3].y-t[2].y)*a/n,t[2].z+(t[3].z-t[2].z)*a/n);r.push(t[3].x,t[3].y,t[3].z);const d=[];d.push(0,1);for(let a=1;a<n;a++)d.push(0,1-a/n);d.push(0,0),d.push(1,0);for(let a=1;a<n;a++)d.push(1,a/n);d.push(1,1);const u=[];for(let a=0;a<n;a++)u.push(a,a+1,n*2-a,a,n*2-a,n*2+1-a);i.setAttribute("position",new p(new Float32Array(r),3)),i.setAttribute("uv",new p(new Float32Array(d),2)),i.setIndex(new p(new Uint32Array(u),1));const y=new C({map:e.videoTextureEnabled?e.videoTexture:e.imageTexture,side:D}),v=new k(i,y);return v.renderOrder=1,v.name=`ModelTVVideoPlugin-${o}-${performance.now()}`,v}),R=t=>{const o=new W().load(t);return o.minFilter=b,o.magFilter=b,o.format=P,o},A=(t,o)=>new Promise((i,n)=>{const r=new XMLHttpRequest;r.onreadystatechange=()=>{if(r.readyState==4)if(r.status==200){const d=window.URL||window.webkitURL;o=o||document.createElement("video"),o.crossOrigin="anonymous",o.autoplay=!0,o.muted=!0,o.loop=!0,o.playsInline=!0,o.src=d.createObjectURL(r.response);const u=new G(o);u.minFilter=b,u.magFilter=b,u.format=P,i(Object.assign(u,{videoSource:t}))}else n(new Error("Video download Error: "+r.status))},r.onerror=d=>n(d),r.open("GET",t),r.responseType="blob",r.send()}),j=async(t,o)=>{const{video_src:i,video_poster_src:n,points:r}=t;e.videoSource=i,e.rectPoints=te(r).map(d=>d.map(({x:u,y,z:v})=>new f(u,y,v))),e.imageTexture=R(n),o&&(e.videoElement=o),e.videoTexture=await A(e.videoSource,e.videoElement),e.enabled=!!t.enable,e.enabled&&g()},L=()=>{x(),e.videoTexture=void 0,s.off("modeChange",()=>c(!0)),s.off("wantsTapGesture",t=>{if(!e.enabled)return;const[o]=t.intersectObjects(s.scene.children,!0);if(!!o&&/^video/.test(o.object.name))return e.videoTexture&&c(!e.videoTexture.image.muted),!1}),s.off("panoArrived",()=>{if(!e.enabled||h())return;const t=s.camera.position;e.rectPoints.find(i=>{const n=i.reduce((r,d)=>new f(r.x+d.x/i.length,r.y+d.y/i.length,r.z+d.z/i.length),new f);return i.map(r=>new f((r.x+n.x)/2,(r.y+n.y)/2,(r.z+n.z)/2)).filter(r=>{r=r.clone().sub(t).normalize();const d=new F(t,r),[u]=d.intersectObjects(s.scene.children,!0);return!!u&&/^video/.test(u.object.name)}).length>=2})||c(!0)}),s.off("renderFrame",()=>{e.videoMeshes.forEach(t=>{t&&(t.needsRender=!0)})})};return s.on("modeChange",()=>c(!0)),s.on("wantsTapGesture",t=>{if(!e.enabled)return;const o=s.scene.children.find(n=>/^ModelTVVideoPlugin/.test(n.name));if(!(!o||t.intersectObjects([o]).length===0))return e.videoTexture&&c(!e.videoTexture.image.muted),!1}),s.on("panoArrived",()=>{if(!e.enabled||h())return;const t=s.camera.position;e.rectPoints.find(i=>{const n=i.reduce((r,d)=>new f(r.x+d.x/i.length,r.y+d.y/i.length,r.z+d.z/i.length),new f);return i.map(r=>new f((r.x+n.x)/2,(r.y+n.y)/2,(r.z+n.z)/2)).filter(r=>{r=r.clone().sub(t).normalize();const d=new F(t,r),[u]=d.intersectObjects(s.scene.children,!0);return!!u&&/^video/.test(u.object.name)}).length>=2})||c(!0)}),s.on("renderFrame",()=>{e.videoMeshes.forEach(t=>{t&&(t.needsRender=!0)})}),Object.assign(window,{$state:e}),{enable:g,disable:x,load:j,dispose:L}};function O(){return{width:window.innerWidth,height:window.innerHeight}}function ne(){const[s,l]=z.exports.useState(O);return z.exports.useEffect(()=>{const e=()=>l(O());return window.addEventListener("resize",e,!1),()=>window.removeEventListener("resize",e,!1)}),s}const oe=[{topLeft:{x:-2.4397027504951727,y:1.321611372744071,z:.9610979887310558},bottomLeft:{x:-2.4441131950417114,y:.7002877178083624,z:.9610504005830736},bottomRight:{x:-3.5409557417698365,y:.7129315526064004,z:.9610934983911138},topRight:{x:-3.5415800323154465,y:1.3188503177101172,z:.961031973361969}}],se={video_src:"https://vrlab-public.ljcdn.com/release/web/videos/tv_ads/360/009.mp4",video_poster_src:"https://vrlab-public.ljcdn.com/release/web/videos/posters/002.9203cf99.jpg",points:oe},ae=s=>{const l=N(),[e,c]=U(),h=z.exports.useRef(null),g=$();return H("modelLoaded",async()=>{if(!h.current)return;const x=g.plugins.modelTVVideoPlugin;await x.load(se),x.enable(),c({panoIndex:2,fov:120,latitude:.22534459988940497,longitude:3.60942475821387})}),l!=="Loaded"?null:M(E,{children:[m(E,{sx:{position:"absolute",left:"13px",bottom:"60px",width:"160px",height:"90px"},children:m("video",{ref:h,style:{position:"absolute",width:"100%",height:"100%"}})}),m(q,{sx:{position:"fixed",bottom:0,left:0,right:0,backgroundColor:"transparent"},className:"model-TV-video-plugin-show",children:M(K,{showLabels:!0,value:e.mode,onChange:(x,w)=>{c({mode:w})},sx:{backgroundColor:"transparent"},children:[m(V,{label:"\u5168\u666F\u6F2B\u6E38",icon:m(X,{}),value:_.Mode.Panorama}),m(V,{label:"\u7A7A\u95F4\u603B\u89C8",icon:m(Y,{}),value:_.Mode.Floorplan})]})})]})},ie=J({imageOptions:{size:512},textureOptions:{size:512},onlyRenderIfNeeds:!0,plugins:[[re,"modelTVVideoPlugin",{}]]}),de=()=>{const s=ne(),l=S(B.WORK);return l&&M(ie,{initialWork:Q(l),ref:e=>Object.assign(window,{$five:e?.five}),children:[m(Z,{...s}),m(ae,{})]})};ee.exports.render(m(de,{}),document.querySelector("#app"));
